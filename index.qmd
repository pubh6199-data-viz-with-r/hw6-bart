---
title: "Final Project: Tobacco History Status | PUBH 6199: Visualizing Data with R"
author:
  - name: Sora Ely; Ashlan Jackson
    affiliation: George Washington University
date: "2025-06-26"
editor: source
format: 
  html:
    toc: true
    toc-location: right
    code-fold: true
    self-contained: true
theme: flatly
mainfont: "Arial"
fontsize: 11pt
execute:
  echo: true
  warning: false
  message: false
output-dir: docs
params:
  number: 6
  purpose: "Final project for PUBH 6199: Visualizing Data with R"
---


```{r}
#| label: setup
#| include: false

knitr::opts_chunk$set(
    warning = FALSE,
    message = FALSE,
    fig.path = "figs/",
    fig.width = 7.252,
    fig.height = 4,
    comment = "#>",
    fig.retina = 3
)
```

## Introduction

_In this project, our team was investigating the clinical departments that acquired a complete tobacco history and our team was interested in which departments needed to improve their data collection._

## Data

_This data came from Sora's clinical research and investigation._

```{r}
#| label: load packages and data
#| eval: true
install.packages("shiny")
install.packages("ggrepel")
install.packages("viridis")
library(tidyverse)
library(readr)
library(ggplot2)
library(shiny)
library(ggrepel)
library(dplyr)
library(viridisLite)
library(viridis)
tobacco_data_weekly_modified <- read_csv("data/tobacco_data_weeklymodified.csv")

tobacco_data_monthly_moified <- read_csv("data/tobacco_data_monthlymodified.csv")


```   

## Visualization 1: "Highest and Lowest Departments with Complete Tobacco History (Weekly)"

_This plot shows the departments with the highest and lowest percentages of a complete tobacco history and plot will help providers diagnoses lung issues sooner._
```{r}

library(ggplot2)
library(dplyr)
library(ggrepel)
library(viridis)

summary_groups <- tobacco_data_weekly_modified %>%
  filter(!group %in% c("Pilot", "Non-Pilot")) %>%
  filter(week_num == max(week_num)) %>%
  group_by(group) %>%
  summarize(final_value = max(percent_complete, na.rm = TRUE)) %>%
  arrange(desc(final_value))

top_groups <- summary_groups %>% slice_head(n = 2) %>% pull(group)
bottom_groups <- summary_groups %>% slice_tail(n = 2) %>% pull(group)
highlight_groups <- c(top_groups, bottom_groups)

highlight_colors <- c(
  setNames(rep("steelblue", 2), top_groups),
  setNames(rep("firebrick", 2), bottom_groups),
  "Other" = "gray80"
)

ggplot(
  tobacco_data_weekly_modified %>%
    filter(!group %in% c("Pilot", "Non-Pilot")) %>%
    mutate(line_group = ifelse(group %in% highlight_groups, group, "Other")),
  aes(x = week_num, y = percent_complete, group = group)
) +
  geom_line(aes(color = line_group, size = line_group, alpha = line_group)) +
  geom_point(aes(color = line_group, alpha = line_group), size = 2) +
  geom_text_repel(
    data = tobacco_data_weekly_modified %>%
      filter(group %in% highlight_groups) %>%
      group_by(group) %>%
      filter(week_num == max(week_num)),
    aes(label = group, color = group),
    nudge_x = 0.3,
    hjust = 0,
    segment.color = NA,
    size = 4,
    show.legend = FALSE
  ) +
  scale_color_manual(values = highlight_colors) +
  scale_size_manual(values = c(setNames(rep(1.4, 4), highlight_groups), "Other" = 0.6)) +
  scale_alpha_manual(values = c(setNames(rep(1, 4), highlight_groups), "Other" = 0.3)) +
  scale_x_continuous(
    breaks = unique(tobacco_data_weekly_modified$week_num),
    labels = paste("Week", unique(tobacco_data_weekly_modified$week_num)),
    expand = expansion(mult = c(0.05, 0.2))
  ) +
  labs(
    title = "Highest and Lowest Departments with Complete Tobacco History (Weekly)",
    x = "Week of",
    y = "Percent Complete"
  ) +
  theme_minimal() +  
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)  # Rotate x labels
  )






```

## Visualization 2: Highest and Lowest Departments Complete Tobacco History (Monthly)",

_This plot shows the departments with the highest and lowest percentages of a complete tobacco history by month and this plot will help providers diagnoses lung issues sooner.._

```{r}
library(ggplot2)
library(dplyr)
library(ggrepel)
library(viridis)

clean_data <- tobacco_data_monthly_moified %>%
  filter(!group %in% c("Pilot", "Non-Pilot", "Geriatrics (Ingleside)"))

summary_groups <- clean_data %>%
  filter(month_num == max(month_num)) %>%
  group_by(group) %>%
  summarize(final_value = max(percent_complete, na.rm = TRUE)) %>%
  arrange(desc(final_value))

top_groups <- summary_groups %>% slice_head(n = 2) %>% pull(group)
bottom_groups <- summary_groups %>% slice_tail(n = 2) %>% pull(group)
highlight_groups <- c(top_groups, bottom_groups)

highlight_colors <- c(
  setNames(rep("steelblue", 2), top_groups),
  setNames(rep("firebrick", 2), bottom_groups),
  "Other" = "gray80"
)

plot_data <- clean_data %>%
  mutate(line_group = ifelse(group %in% highlight_groups, group, "Other"))

ggplot(plot_data, aes(x = month_num, y = percent_complete, group = group)) +
  geom_line(aes(color = line_group, size = line_group, alpha = line_group)) +
  geom_point(aes(color = line_group, alpha = line_group), size = 2) +
  geom_text_repel(
    data = plot_data %>%
      filter(group %in% highlight_groups) %>%
      group_by(group) %>%
      filter(month_num == max(month_num)),
    aes(label = group, color = group),
    nudge_x = 0.3,
    hjust = 0,
    segment.color = NA,
    size = 4,
    show.legend = FALSE
  ) +
  scale_color_manual(values = highlight_colors) +
  scale_size_manual(values = c(setNames(rep(1.4, 4), highlight_groups), "Other" = 0.6)) +
  scale_alpha_manual(values = c(setNames(rep(1, 4), highlight_groups), "Other" = 0.3)) +
  scale_x_continuous(
    breaks = 1:12,
    labels = month.abb[1:12], 
    expand = expansion(mult = c(0.05, 0.2))
  ) +
  scale_y_continuous(
    limits = c(0, 1),
    labels = scales::percent_format(accuracy = 1)
  ) +
  labs(
    title = "Highest and Lowest Departments Complete Tobacco History (Monthly)",
    x = "Month",
    y = "Percent Complete"
  ) +
  theme_minimal() +
  theme(legend.position = "none")




```

## Visualization 3: [Title Here]

_Describe what this plot shows, and why it's important._

```{r}
# your code here
```

## OR Shiny app: [Title Here]

_If you choose to create a Shiny app, describe the app's purpose and functionality. Save your code inside the shiny-app/ folder, replace the URL below with your app's URL_

[Click here to open the interactive Shiny app](https://cindyhu.shinyapps.io/two-files-app/)

## Interpretation

_Our findings summarize which department are achieving completed tobacco histories and which are not. By knowing this data, researchers will be able to work with certain departments to obtain better complete results, which in turn will improve lung screening rates_

## Limitations

_There were a few design limitations. These included issues with grouping subspecialties as well as a misalignment between week data and monthly data. Additionally, the pilot and nonpilot lines had to be removed from the static graphs and the top and lowest had to be highlighted due to the overstauration of lines with all the subspecialties included. All the subspecialties made the graph too busy._

## Conclusion

_The hope of these graph is to help diagnose lunch cancer and improve sceenings. _

## References

_Include any references to data sources, packages, or literature you used. If your visualization design is inspired by someone else's work, cite those too._

1. Reference 1: Sora's Clinical Dataset. 
2. Reference 2
3. Reference 3

